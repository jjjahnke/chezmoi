#!/bin/bash
#
# This script is run once to securely store Docker credentials in pass.
# It requires a GPG key to be configured for the user.

set -eufo pipefail

# This is the standard path 'pass' uses for the Docker Hub registry
PASS_PATH="docker-logins/index.docker.io"

echo "Checking for Docker credentials in pass..."

# Only run if the credential is not already in the store
if pass show "${PASS_PATH}" >/dev/null 2>&1; then
    echo "Credential for ${PASS_PATH} already exists in pass. Skipping."
    exit 0
fi

echo "Credential not found. Fetching from Vault and piping to pass..."

# Use chezmoi to render *only* the secret and pipe it directly to pass.
# This avoids all shell variable assignment and parsing issues.
# The first line of the secret in pass should be the password/token.
chezmoi execute-template '{{ (vault (printf "secret/%s/docker" .data.machineType)).data.data.password }}' | pass insert -e -m "${PASS_PATH}"

if [ $? -eq 0 ]; then
    echo "Successfully stored Docker credentials for ${PASS_PATH} in pass."
else
    echo "Error: Failed to store Docker credentials."
    exit 1
fi

